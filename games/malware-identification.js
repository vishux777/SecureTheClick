// Malware Identification Game
class MalwareIdentificationGame {
    constructor() {
        this.storage = new GameStorage();
        this.feedback = new FeedbackSystem();
        this.currentRound = 1;
        this.maxRounds = 5;
        this.score = 0;
        this.hintsLeft = 3;
        this.startTime = Date.now();
        this.threatsFound = 0;
        this.selectedFiles = [];
        this.currentRoundData = null;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadRound();
        this.updateDisplay();
        this.feedback.gameStarted('Malware Identification');
    }

    setupEventListeners() {
        // Hint button
        document.getElementById('hintBtn').addEventListener('click', () => {
            this.showHint();
        });

        // Check answers button
        document.getElementById('checkAnswers').addEventListener('click', () => {
            this.checkAnswers();
        });

        // Next round button
        document.getElementById('nextRound').addEventListener('click', () => {
            this.nextRound();
        });

        // Reset round button
        document.getElementById('resetRound').addEventListener('click', () => {
            this.resetRound();
        });
    }

    loadRound() {
        this.currentRoundData = this.getRoundData(this.currentRound);
        this.selectedFiles = [];
        
        document.getElementById('roundTitle').textContent = this.currentRoundData.title;
        document.getElementById('roundDescription').textContent = this.currentRoundData.description;
        
        this.renderFiles();
        document.getElementById('nextRound').style.display = 'none';
    }

    getRoundData(round) {
        const rounds = {
            1: {
                title: "Email Attachments",
                description: "You've received several emails with attachments. Identify which files are potentially dangerous.",
                files: [
                    {
                        id: "invoice-pdf",
                        name: "Invoice_2024.pdf",
                        size: "245 KB",
                        type: "PDF Document",
                        source: "accounting@company.com",
                        icon: "fas fa-file-pdf",
                        isMalware: false,
                        reasoning: "Legitimate PDF from known business contact with reasonable size."
                    },
                    {
                        id: "photo-exe",
                        name: "vacation_photos.exe",
                        size: "15 MB",
                        type: "Executable",
                        source: "friend@email.com",
                        icon: "fas fa-file-code",
                        isMalware: true,
                        reasoning: "Photos should be image files (.jpg, .png), not executables (.exe)."
                    },
                    {
                        id: "resume-doc",
                        name: "Resume_JohnDoe.docx",
                        size: "156 KB",
                        type: "Word Document",
                        source: "hr@company.com",
                        icon: "fas fa-file-word",
                        isMalware: false,
                        reasoning: "Normal Word document from HR with appropriate size."
                    },
                    {
                        id: "security-update",
                        name: "Security_Update.scr",
                        size: "2.3 MB",
                        type: "Screen Saver",
                        source: "security@micr0soft.com",
                        icon: "fas fa-desktop",
                        isMalware: true,
                        reasoning: "Screen saver files (.scr) are often disguised malware, and the sender domain is suspicious."
                    },
                    {
                        id: "spreadsheet",
                        name: "Budget_2024.xlsx",
                        size: "89 KB",
                        type: "Excel Spreadsheet",
                        source: "finance@company.com",
                        icon: "fas fa-file-excel",
                        isMalware: false,
                        reasoning: "Normal Excel file from finance department with appropriate size."
                    },
                    {
                        id: "double-extension",
                        name: "document.pdf.exe",
                        size: "8.7 MB",
                        type: "Executable",
                        source: "unknown sender",
                        icon: "fas fa-file-code",
                        isMalware: true,
                        reasoning: "Double extensions are used to hide malware. This is an executable disguised as a PDF."
                    }
                ]
            },
            2: {
                title: "Software Downloads",
                description: "You're downloading software from various websites. Which downloads should you avoid?",
                files: [
                    {
                        id: "adobe-reader",
                        name: "AdobeReader_Official.exe",
                        size: "167 MB",
                        type: "Installer",
                        source: "adobe.com",
                        icon: "fas fa-file-download",
                        isMalware: false,
                        reasoning: "Official Adobe Reader from legitimate adobe.com website."
                    },
                    {
                        id: "fake-codec",
                        name: "VideoCodec_Required.exe",
                        size: "3.2 MB",
                        type: "Codec Pack",
                        source: "codec-downloads.tk",
                        icon: "fas fa-video",
                        isMalware: true,
                        reasoning: "Fake codec downloads are common malware delivery methods."
                    },
                    {
                        id: "antivirus-real",
                        name: "AVG_Antivirus_2024.msi",
                        size: "398 MB",
                        type: "Windows Installer",
                        source: "avg.com",
                        icon: "fas fa-shield-virus",
                        isMalware: false,
                        reasoning: "Legitimate antivirus software from official AVG website."
                    },
                    {
                        id: "game-crack",
                        name: "Game_Crack_Tool.rar",
                        size: "12 MB",
                        type: "Archive",
                        source: "warez-site.net",
                        icon: "fas fa-gamepad",
                        isMalware: true,
                        reasoning: "Game cracks and piracy tools often contain malware."
                    },
                    {
                        id: "office-installer",
                        name: "Office365_Setup.exe",
                        size: "2.1 GB",
                        type: "Installer",
                        source: "microsoft.com",
                        icon: "fas fa-briefcase",
                        isMalware: false,
                        reasoning: "Official Microsoft Office installer from legitimate Microsoft website."
                    },
                    {
                        id: "system-optimizer",
                        name: "SystemSpeedBooster.exe",
                        size: "45 MB",
                        type: "System Tool",
                        source: "speedup-pc.biz",
                        icon: "fas fa-tachometer-alt",
                        isMalware: true,
                        reasoning: "System optimizers from unknown sources are often potentially unwanted programs or malware."
                    }
                ]
            },
            3: {
                title: "USB Drive Contents",
                description: "You found a USB drive in the parking lot. Examine its contents for potential threats.",
                files: [
                    {
                        id: "autorun-inf",
                        name: "autorun.inf",
                        size: "1 KB",
                        type: "Configuration File",
                        source: "USB Root",
                        icon: "fas fa-cog",
                        isMalware: true,
                        reasoning: "Autorun.inf files can automatically execute malware when USB is inserted."
                    },
                    {
                        id: "presentation",
                        name: "Company_Presentation.pptx",
                        size: "15 MB",
                        type: "PowerPoint",
                        source: "USB Drive",
                        icon: "fas fa-file-powerpoint",
                        isMalware: false,
                        reasoning: "Normal PowerPoint presentation, though you should still be cautious with unknown USB drives."
                    },
                    {
                        id: "hidden-system",
                        name: "System32.exe",
                        size: "234 KB",
                        type: "Executable",
                        source: "USB Drive",
                        icon: "fas fa-file-code",
                        isMalware: true,
                        reasoning: "Legitimate system32 is a folder, not an executable file. This is malware."
                    },
                    {
                        id: "photos-folder",
                        name: "Family_Photos.zip",
                        size: "89 MB",
                        type: "Archive",
                        source: "USB Drive",
                        icon: "fas fa-file-archive",
                        isMalware: false,
                        reasoning: "Appears to be a normal photo archive, though contents should be scanned."
                    },
                    {
                        id: "recycler-folder",
                        name: "$RECYCLER",
                        size: "0 KB",
                        type: "System Folder",
                        source: "USB Drive",
                        icon: "fas fa-folder",
                        isMalware: true,
                        reasoning: "$RECYCLER folders on USB drives often contain worms and malware."
                    },
                    {
                        id: "backup-file",
                        name: "Important_Backup.bak",
                        size: "456 MB",
                        type: "Backup File",
                        source: "USB Drive",
                        icon: "fas fa-save",
                        isMalware: false,
                        reasoning: "Normal backup file, though you should verify contents before using."
                    }
                ]
            },
            4: {
                title: "Mobile App Files",
                description: "You're examining files from various mobile apps and downloads. Identify the potentially malicious ones.",
                files: [
                    {
                        id: "official-app",
                        name: "WhatsApp.apk",
                        size: "45 MB",
                        type: "Android App",
                        source: "Google Play Store",
                        icon: "fab fa-android",
                        isMalware: false,
                        reasoning: "Official WhatsApp APK from Google Play Store."
                    },
                    {
                        id: "fake-app",
                        name: "WhatsAp.apk",
                        size: "12 MB",
                        type: "Android App",
                        source: "third-party-apps.net",
                        icon: "fab fa-android",
                        isMalware: true,
                        reasoning: "Misspelled app name and from unofficial source - likely malware."
                    },
                    {
                        id: "ios-profile",
                        name: "Enterprise_Config.mobileconfig",
                        size: "5 KB",
                        type: "iOS Profile",
                        source: "unknown-enterprise.com",
                        icon: "fab fa-apple",
                        isMalware: true,
                        reasoning: "iOS configuration profiles from unknown sources can compromise device security."
                    },
                    {
                        id: "update-file",
                        name: "System_Update_v2.1.zip",
                        size: "156 MB",
                        type: "Update Package",
                        source: "phoneupdate.tk",
                        icon: "fas fa-mobile-alt",
                        isMalware: true,
                        reasoning: "System updates should come through official channels, not third-party websites."
                    },
                    {
                        id: "game-data",
                        name: "CandyCrush_SaveGame.dat",
                        size: "2.3 MB",
                        type: "Game Data",
                        source: "Game Folder",
                        icon: "fas fa-gamepad",
                        isMalware: false,
                        reasoning: "Normal game save file with appropriate size and format."
                    },
                    {
                        id: "malicious-installer",
                        name: "Free_Premium_Apps.jar",
                        size: "67 MB",
                        type: "Java Archive",
                        source: "free-apps.biz",
                        icon: "fab fa-java",
                        isMalware: true,
                        reasoning: "JAR files offering 'free premium apps' are typically malware distribution methods."
                    }
                ]
            },
            5: {
                title: "Advanced Threats",
                description: "This round contains sophisticated threats. Use all your knowledge to identify the dangerous files.",
                files: [
                    {
                        id: "macro-document",
                        name: "Invoice_Details.docm",
                        size: "234 KB",
                        type: "Macro-Enabled Document",
                        source: "billing@supplier-corp.com",
                        icon: "fas fa-file-word",
                        isMalware: true,
                        reasoning: "Macro-enabled documents from external sources can contain malicious macros."
                    },
                    {
                        id: "legitimate-pdf",
                        name: "Annual_Report_2024.pdf",
                        size: "3.4 MB",
                        type: "PDF Document",
                        source: "investor-relations@company.com",
                        icon: "fas fa-file-pdf",
                        isMalware: false,
                        reasoning: "Normal PDF from legitimate business source with reasonable size."
                    },
                    {
                        id: "powershell-script",
                        name: "system_maintenance.ps1",
                        size: "15 KB",
                        type: "PowerShell Script",
                        source: "it-support@company.co.in",
                        icon: "fas fa-terminal",
                        isMalware: true,
                        reasoning: "PowerShell scripts from suspicious domains should be treated with extreme caution."
                    },
                    {
                        id: "certificate",
                        name: "SecurityCertificate.p12",
                        size: "4 KB",
                        type: "Digital Certificate",
                        source: "security@bank.com",
                        icon: "fas fa-certificate",
                        isMalware: false,
                        reasoning: "Digital certificate from legitimate banking institution."
                    },
                    {
                        id: "dll-file",
                        name: "vcruntime140.dll",
                        size: "89 KB",
                        type: "Dynamic Library",
                        source: "software installation",
                        icon: "fas fa-puzzle-piece",
                        isMalware: false,
                        reasoning: "Legitimate Visual C++ runtime library file."
                    },
                    {
                        id: "suspicious-dll",
                        name: "user32.dll.exe",
                        size: "2.1 MB",
                        type: "Executable",
                        source: "temp download",
                        icon: "fas fa-file-code",
                        isMalware: true,
                        reasoning: "System DLL files should not have .exe extensions. This is malware disguised as a system file."
                    },
                    {
                        id: "browser-extension",
                        name: "AdBlocker_Pro.crx",
                        size: "892 KB",
                        type: "Chrome Extension",
                        source: "chrome-extensions.net",
                        icon: "fab fa-chrome",
                        isMalware: true,
                        reasoning: "Browser extensions should only be installed from official stores, not third-party sites."
                    },
                    {
                        id: "image-steganography",
                        name: "vacation_photo.jpg",
                        size: "8.9 MB",
                        type: "JPEG Image",
                        source: "friend@email.com",
                        icon: "fas fa-image",
                        isMalware: true,
                        reasoning: "Unusually large for a JPEG photo - may contain hidden malware using steganography."
                    }
                ]
            }
        };

        return rounds[round] || rounds[1];
    }

    renderFiles() {
        const fileGrid = document.getElementById('fileGrid');
        fileGrid.innerHTML = '';

        // Shuffle files for each round
        const shuffledFiles = this.shuffleArray([...this.currentRoundData.files]);

        shuffledFiles.forEach(file => {
            const fileElement = document.createElement('div');
            fileElement.className = 'file-item';
            fileElement.dataset.id = file.id;
            
            fileElement.innerHTML = `
                <div class="file-icon">
                    <i class="${file.icon}"></i>
                </div>
                <div class="file-name">${file.name}</div>
                <div class="file-type">${file.type}</div>
                <div class="file-size">${file.size}</div>
                <div class="file-source">From: ${file.source}</div>
            `;

            fileElement.addEventListener('click', () => {
                this.toggleFileSelection(file, fileElement);
            });

            fileGrid.appendChild(fileElement);
        });
    }

    toggleFileSelection(file, element) {
        if (this.selectedFiles.includes(file.id)) {
            // Deselect
            this.selectedFiles = this.selectedFiles.filter(id => id !== file.id);
            element.classList.remove('selected');
        } else {
            // Select
            this.selectedFiles.push(file.id);
            element.classList.add('selected');
        }
    }

    checkAnswers() {
        let correctIdentifications = 0;
        let falsePositives = 0;
        let missedThreats = 0;

        // Check each file
        this.currentRoundData.files.forEach(file => {
            const element = document.querySelector(`[data-id="${file.id}"]`);
            const isSelected = this.selectedFiles.includes(file.id);
            
            if (file.isMalware && isSelected) {
                // Correctly identified malware
                correctIdentifications++;
                element.classList.add('malware');
                element.classList.remove('selected');
            } else if (file.isMalware && !isSelected) {
                // Missed malware
                missedThreats++;
                element.classList.add('malware');
            } else if (!file.isMalware && isSelected) {
                // False positive
                falsePositives++;
                element.classList.add('safe');
                element.classList.remove('selected');
            } else {
                // Correctly identified as safe
                element.classList.add('safe');
            }
        });

        // Calculate score
        const totalMalware = this.currentRoundData.files.filter(f => f.isMalware).length;
        const roundScore = (correctIdentifications * 50) - (falsePositives * 20) - (missedThreats * 30);
        this.score += Math.max(0, roundScore);
        this.threatsFound += correctIdentifications;

        // Show feedback
        let feedbackMessage = '';
        if (missedThreats === 0 && falsePositives === 0) {
            feedbackMessage = `Perfect! You identified all ${correctIdentifications} threats correctly!`;
            this.feedback.success(feedbackMessage);
        } else if (missedThreats === 0) {
            feedbackMessage = `Good job! You found all threats but had ${falsePositives} false positive(s).`;
            this.feedback.warning(feedbackMessage);
        } else {
            feedbackMessage = `You found ${correctIdentifications}/${totalMalware} threats. Review the missed items.`;
            this.feedback.warning(feedbackMessage);
        }

        // Show explanations
        setTimeout(() => {
            this.showExplanations();
        }, 2000);

        document.getElementById('nextRound').style.display = 'inline-block';
        this.updateDisplay();
    }

    showExplanations() {
        const malwareFiles = this.currentRoundData.files.filter(f => f.isMalware);
        if (malwareFiles.length > 0) {
            let explanationText = "Threat Analysis:\n\n";
            malwareFiles.forEach(file => {
                explanationText += `• ${file.name}: ${file.reasoning}\n`;
            });
            
            this.feedback.info(explanationText, {
                title: '🔍 Threat Analysis',
                duration: 10000
            });
        }
    }

    showHint() {
        if (this.hintsLeft <= 0) {
            this.feedback.warning('No hints remaining!');
            return;
        }

        const hints = {
            1: "Look for executable files (.exe, .scr) in email attachments and check sender domains carefully.",
            2: "Avoid downloads from suspicious websites and be wary of system optimizers or codec packs.",
            3: "USB drives can contain autorun files and system folder names that hide malware.",
            4: "Mobile malware often uses misspelled app names or comes from unofficial sources.",
            5: "Advanced threats include macro-enabled documents, suspicious scripts, and files with double extensions."
        };

        this.hintsLeft--;
        this.feedback.hintUsed(this.hintsLeft);
        
        setTimeout(() => {
            this.feedback.info(hints[this.currentRound] || "Look for suspicious file extensions, unusual sizes, and questionable sources.", {
                title: '💡 Hint',
                duration: 8000
            });
        }, 500);

        this.updateDisplay();
    }

    nextRound() {
        if (this.currentRound < this.maxRounds) {
            this.currentRound++;
            this.loadRound();
            this.updateDisplay();
        } else {
            this.endGame();
        }
    }

    resetRound() {
        this.selectedFiles = [];
        
        document.querySelectorAll('.file-item').forEach(element => {
            element.classList.remove('selected', 'malware', 'safe');
        });
        
        document.getElementById('nextRound').style.display = 'none';
        this.feedback.info('Round reset. Select the files you think are malware.');
    }

    endGame() {
        const finalTime = Math.floor((Date.now() - this.startTime) / 1000);
        
        // Completion bonus
        this.score += 300;
        
        const stats = this.storage.updateGameScore('malware-identification', this.score, finalTime);
        
        this.feedback.gameComplete(this.score, stats.bestScores.malwareIdentification, 'Malware Identification');
        
        setTimeout(() => {
            const timeString = `${Math.floor(finalTime/60)}:${(finalTime%60).toString().padStart(2,'0')}`;
            alert(`Congratulations!\n\nYou've completed Malware Identification training!\nFinal Score: ${this.score}\nTime: ${timeString}\nThreats Found: ${this.threatsFound}\n\nYou're now a malware detection expert!`);
            window.location.href = '../index.html';
        }, 2000);
    }

    updateDisplay() {
        document.getElementById('currentScore').textContent = this.score;
        document.getElementById('currentRound').textContent = this.currentRound;
        document.getElementById('threatsFound').textContent = this.threatsFound;
        document.getElementById('hintsLeft').textContent = this.hintsLeft;
        
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timeDisplay').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }
}

// Initialize game when page loads
document.addEventListener('DOMContentLoaded', () => {
    new MalwareIdentificationGame();
});
